<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contact List</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .logo { font-family: 'Segoe UI', Roboto, Arial, sans-serif; font-weight:800; letter-spacing:2px; }
    .pill-nav a { transition: all .18s ease; }
    .glass { background: rgba(255, 255, 0, 0.15); backdrop-filter: blur(3px); }
    .modal-bg { background: rgba(0,0,0,0.5); }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center text-gray-800">

  <!-- Layer trung tâm -->
  <div class="bg-gradient-to-b from-yellow-200 via-yellow-100 to-white rounded-2xl shadow-2xl max-w-6xl w-full mx-4 p-8 border border-yellow-300">

    <!-- Header -->
    <header class="text-center">
      <h1 class="logo text-4xl text-red-600 drop-shadow-md">&lt;23127229&gt;</h1>
      <nav class="mt-4 inline-block">
        <div class="pill-nav bg-blue-500 rounded-full px-6 py-2 shadow-md">
          <a href="#" class="px-4 py-1 text-white font-semibold">Home</a>
          <a href="#" class="px-4 py-1 text-red-600 font-semibold">About</a>
          <a href="#" class="px-4 py-1 text-white font-semibold">Services</a>
          <a href="#" class="px-4 py-1 text-white font-semibold">Contact</a>
        </div>
      </nav>
    </header>

    <main class="mt-10 px-6">
      <div class="grid grid-cols-12 gap-6">
        <div class="col-span-12 md:col-span-4">
          <div class="glass p-6 rounded-md shadow-md border border-yellow-400">
            <h2 class="text-xl font-bold text-black-700">Registration Form</h2>
            <form id="regForm" class="mt-6 space-y-6">
              <div>
                <label class="block text-sm text-gray-800">First Name</label>
                <input id="firstName" class="mt-2 w-full bg-white border border-yellow-300 rounded-lg px-4 py-3 text-gray-800 focus:ring-2 focus:ring-yellow-500" placeholder="Jane" />
              </div>
              <div>
                <label class="block text-sm text-gray-800">Last Name</label>
                <input id="lastName" class="mt-2 w-full bg-white border border-yellow-300 rounded-lg px-4 py-3 text-gray-800 focus:ring-2 focus:ring-yellow-500" placeholder="Smith" />
              </div>
              <div>
                <label class="block text-sm text-gray-800">Email</label>
                <input id="email" type="email" class="mt-2 w-full bg-white border border-yellow-300 rounded-lg px-4 py-3 text-gray-800 focus:ring-2 focus:ring-yellow-500" placeholder="jane.smith@example.com" />
              </div>

              <div class="flex items-center gap-4">
                <button type="button" id="updateBtn" class="px-6 py-2 rounded-lg bg-green-600 text-white font-semibold shadow hover:brightness-110" disabled>Update</button>
                <button type="button" id="registerBtn" class="px-6 py-2 rounded-lg bg-blue-600 text-white font-semibold shadow hover:brightness-110">Register</button>
              </div>
            </form>
          </div>
        </div>

        <div class="col-span-12 md:col-span-8">
          <div class="glass p-6 rounded-md shadow-md border border-yellow-400">
            <h2 class="text-xl font-bold text-black-700">Current List</h2>

            <div class="mt-6 overflow-x-auto">
              <table class="w-full text-left table-auto">
                <thead>
                  <tr class="text-sm text-gray-800 border-b border-gray-300">
                    <th class="w-12">#</th>
                    <th class="px-4">FULL NAME</th>
                    <th class="px-4">EMAIL</th>
                    <th class="px-4 text-right">ACTIONS</th>
                  </tr>
                </thead>
                <tbody id="contactTable" class="mt-4"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <footer class="text-center py-8 text-grey-800">
        <nav class="space-x-4">
          <a href="#">Home</a>
          <a href="#" class="text-red-600 underline">About</a>
          <a href="#">Services</a>
          <a href="#">Contact</a>
        </nav>
      </footer>
    </main>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center modal-bg z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 text-center">
      <h3 class="text-lg font-semibold text-blue-700 mb-4">Thông báo</h3>
      <p id="modalMsg" class="text-gray-700 mb-6">Vui lòng điền đầy đủ thông tin.</p>
      <button id="closeModal" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:brightness-110">Đóng</button>
    </div>
  </div>

  <script>
    let contacts = [];
    let editId = null;

    const contactTable = document.getElementById('contactTable');
    const firstName = document.getElementById('firstName');
    const lastName = document.getElementById('lastName');
    const email = document.getElementById('email');
    const registerBtn = document.getElementById('registerBtn');
    const updateBtn = document.getElementById('updateBtn');
    const modal = document.getElementById('modal');
    const modalMsg = document.getElementById('modalMsg');
    const closeModal = document.getElementById('closeModal');

    // Modal hiển thị thông báo
    function showModal(msg) {
      modalMsg.textContent = msg;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    closeModal.addEventListener('click', () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    });

    // Escape HTML an toàn
    function escapeHtml(s) {
      if (!s) return '';
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    // Render danh sách ra bảng
    function render() {
      contactTable.innerHTML = '';
      contacts.forEach((c) => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-yellow-200';
        tr.innerHTML = `
          <td class="py-4 text-gray-700 font-semibold">${c.id}</td>
          <td class="px-4 py-4">${escapeHtml(c.full)}</td>
          <td class="px-4 py-4 text-gray-600">${escapeHtml(c.email)}</td>
          <td class="px-4 py-4 text-right">
            <button data-id="${c.id}" class="editBtn inline-block px-3 py-1 mr-2 rounded-md bg-blue-500 text-white hover:brightness-110">Edit</button>
            <button data-id="${c.id}" class="delBtn inline-block px-3 py-1 rounded-md bg-red-500 text-white hover:brightness-110">Delete</button>
          </td>`;
        contactTable.appendChild(tr);
      });

      document.querySelectorAll('.editBtn').forEach(b => b.addEventListener('click', onEdit));
      document.querySelectorAll('.delBtn').forEach(b => b.addEventListener('click', onDelete));
    }

    // Fetch dữ liệu ban đầu từ server
    async function loadContacts() {
      try {
        const res = await fetch('/api/contacts');
        contacts = await res.json();
        render();
      } catch (err) {
        showModal('Không thể tải dữ liệu từ máy chủ.');
      }
    }

    // Thêm contact
    registerBtn.addEventListener('click', async () => {
      const f = firstName.value.trim();
      const l = lastName.value.trim();
      const em = email.value.trim();
      if (!f || !l || !em) return showModal('Vui lòng điền đầy đủ thông tin.');

      try {
        const res = await fetch('/api/contacts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ full: `${f} ${l}`, email: em })
        });
        if (!res.ok) throw new Error();
        await loadContacts();
        firstName.value = lastName.value = email.value = '';
      } catch {
        showModal('Không thể thêm mới liên hệ.');
      }
    });

    // Edit
    function onEdit(e) {
      const id = Number(e.currentTarget.dataset.id);
      const c = contacts.find(x => x.id === id);
      if (!c) return;
      const parts = c.full.split(' ');
      firstName.value = parts.shift() || '';
      lastName.value = parts.join(' ') || '';
      email.value = c.email;
      editId = id;
      updateBtn.disabled = false;
      registerBtn.disabled = true;
    }

    // Update
    updateBtn.addEventListener('click', async () => {
      if (!editId) return;
      const f = firstName.value.trim();
      const l = lastName.value.trim();
      const em = email.value.trim();
      if (!f || !l || !em) return showModal('Vui lòng điền đầy đủ thông tin.');

      try {
        const res = await fetch(`/api/contacts/${editId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ full: `${f} ${l}`, email: em })
        });
        if (!res.ok) throw new Error();
        await loadContacts();
        editId = null;
        updateBtn.disabled = true;
        registerBtn.disabled = false;
        firstName.value = lastName.value = email.value = '';
      } catch {
        showModal('Cập nhật thất bại.');
      }
    });

    // Delete
    async function onDelete(e) {
      const id = Number(e.currentTarget.dataset.id);
      try {
        const res = await fetch(`/api/contacts/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error();
        await loadContacts();
      } catch {
        showModal('Không thể xóa liên hệ.');
      }
    }

    // Khởi chạy
    loadContacts();
  </script>
</body>
</html>
